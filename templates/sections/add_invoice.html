{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">âž• Add an Invoice</h2>

    <form method="post">
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="client_id" class="form-label">ðŸ‘¤ Select Client</label>
                <select class="form-select" name="client_id" required>
                    <option value="" disabled selected>-- Choose a client --</option>
                    {% for client in clients %}
                        <option value="{{ client.id }}">{{ client.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="invoice_number" class="form-label">ðŸ“„ Invoice Number</label>
                <input type="text" class="form-control" name="invoice_number" required>
            </div>
        </div>

        <hr>
        <h5 class="mb-3">ðŸ›’ Items</h5>

        <div id="items-container">
            <div class="row item mb-3">
                <div class="col-md-4">
                    <select class="form-select product-select" name="product_id[]" required onchange="updatePrice(this)">
                        <option value="" disabled selected>-- Choose product --</option>
                        {% for p in products %}
                            <option value="{{ p.id }}" data-price="{{ p.product_price }}">{{ p.product_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control" name="quantity[]" placeholder="Quantity" min="1" required>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control unit-price" name="unit_price[]" placeholder="Unit Price (CHF)" step="0.01" required readonly>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <button type="button" class="btn btn-outline-secondary" onclick="addItem()">âž• Add an Item</button>
        </div>

        <button type="submit" class="btn btn-success">ðŸ’¾ Save Invoice</button>
        <a href="{{ url_for('invoices.invoices_list') }}" class="btn btn-secondary ms-2">â¬… Back</a>
    </form>
</div>

<script>
function updatePrice(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const price = selectedOption.getAttribute('data-price');
    const row = selectElement.closest('.row');
    const priceInput = row.querySelector('.unit-price');
    if (priceInput && price) {
        priceInput.value = price;
    }
}

function addItem() {
    const container = document.getElementById('items-container');
    const newItem = document.createElement('div');
    newItem.classList.add('row', 'item', 'mb-3');
    newItem.innerHTML = `
        <div class="col-md-4">
            <select class="form-select product-select" name="product_id[]" required onchange="updatePrice(this)">
                <option value="" disabled selected>-- Choose product --</option>
                {% for p in products %}
                    <option value="{{ p.id }}" data-price="{{ p.product_price }}">{{ p.product_name }} - {{ p.product_price }} CHF</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="quantity[]" placeholder="Quantity" min="1" required>
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control unit-price" name="unit_price[]" placeholder="Unit Price (CHF)" step="0.01" required>
        </div>
    `;
    container.appendChild(newItem);
}
</script>
{% endblock %}
